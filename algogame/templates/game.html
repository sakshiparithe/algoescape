{% extends "base.html" %}
{% block content %}
<div class="game-container" data-level-id="{{ level_data.id }}">
    <div class="game-header">
        <h1>{{ algorithm.replace('_', ' ').title() }} - Level {{ level_data.id }}</h1>
        <div class="game-info">
            <span class="difficulty-badge {{ difficulty }}">{{ difficulty.title() }}</span>
            <span class="level-info">{{ level_data.description }}</span>
        </div>
    </div>

    <div class="game-controls">
        <button onclick="generateArray()" class="btn btn-green">üé≤ Generate Array</button>
        <button onclick="getHint()" class="btn btn-blue">üí° Get Hint</button>
        <button onclick="restartGame()" class="btn btn-orange">üîÑ Restart</button>
        <button onclick="quitGame()" class="btn btn-red">‚ùå Quit</button>
    </div>

    <div class="game-stats">
        <div class="stat-item">
            <span class="stat-label">Steps:</span>
            <span id="steps" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Time:</span>
            <span id="timer" class="stat-value">00:00</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Hints:</span>
            <span id="hints-used" class="stat-value">0</span>
        </div>
    </div>

    <div class="array-container">
        <h3>Current Array:</h3>
        <div id="array" class="array-display"></div>
        <button onclick="openArrayModal()" class="btn btn-blue">üéØ Open Array Workspace</button>
    </div>

    <!-- Array Manipulation Modal -->
    <div id="array-modal" class="modal" style="display: none;">
        <div class="modal-content-large">
            <div class="modal-header">
                <h2>üéØ Array Workspace</h2>
                <button onclick="closeArrayModal()" class="btn btn-red btn-small">‚ùå Close</button>
            </div>
            
            <div class="modal-body">
                <div class="workspace-array">
                    <h4>Working Array:</h4>
                    <div id="workspace-array" class="array-display-large"></div>
                </div>
                
                <div class="sorting-controls">
                    <h3>üéØ Sorting Controls</h3>
                    <div class="control-buttons">
                        <div class="control-group">
                            <label>Select Elements:</label>
                            <button onclick="selectElement(0)" class="btn btn-small">Select First</button>
                            <button onclick="selectElement(1)" class="btn btn-small">Select Second</button>
                            <button onclick="selectElement(2)" class="btn btn-small">Select Third</button>
                        </div>
                        
                        <div class="control-group">
                            <label>Actions:</label>
                            <button onclick="swapElements()" class="btn btn-orange">üîÑ Swap Selected</button>
                            <button onclick="compareElements()" class="btn btn-blue">üîç Compare</button>
                            <button onclick="moveElement()" class="btn btn-green">‚û°Ô∏è Move Right</button>
                            <button onclick="moveElementLeft()" class="btn btn-green">‚¨ÖÔ∏è Move Left</button>
                        </div>
                        
                        <div class="control-group">
                            <label>Quick Actions:</label>
                            <button onclick="findSmallest()" class="btn btn-purple">üîç Find Smallest</button>
                            <button onclick="findLargest()" class="btn btn-purple">üîç Find Largest</button>
                            <button onclick="insertElement()" class="btn btn-cyan">üìå Insert</button>
                        </div>
                    </div>
                    
                    <div class="selected-info">
                        <span>Selected: </span>
                        <span id="selected-elements">None</span>
                        <span> | Last Action: </span>
                        <span id="last-action">None</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="syncToMain()" class="btn btn-green">‚úÖ Sync to Main</button>
                <button onclick="resetWorkspace()" class="btn btn-orange">üîÑ Reset Workspace</button>
            </div>
        </div>
    </div>

    <div class="action-area">
        <button onclick="submitSolution()" class="btn btn-success btn-large">‚úÖ Submit Solution</button>
    </div>

    <div id="hint-box" class="hint-box" style="display: none;">
        <h4>üí° AI Hint:</h4>
        <p id="hint-text"></p>
        <button onclick="closeHint()" class="btn btn-small">Close</button>
    </div>

    <div id="result-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 id="result-title"></h2>
            <div id="result-stats"></div>
            <div id="quiz-section" style="display: none;">
                <h3>üß™ Quick Quiz</h3>
                <div id="quiz-question"></div>
                <div id="quiz-options"></div>
                <button onclick="submitQuizAnswer()" class="btn btn-blue">Submit Answer</button>
            </div>
            <div class="modal-actions">
                <button onclick="nextLevel()" class="btn btn-green">Next Level</button>
                <button onclick="retryLevel()" class="btn btn-orange">Retry</button>
                <button onclick="backToMenu()" class="btn btn-red">Back to Menu</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentArray = [];
let steps = 0;
let hintsUsed = 0;
let startTime = null;
let timerInterval = null;
let currentQuiz = null;

const algorithm = '{{ algorithm }}';
const difficulty = '{{ difficulty }}';
const levelId = parseInt(document.querySelector('.game-container').dataset.levelId || '1');

// Interactive sorting variables
let selectedIndices = [];
let workspaceArray = [];

// Modal functions
function openArrayModal() {
    if (!currentArray.length) {
        alert('Please generate an array first!');
        return;
    }
    
    // Copy current array to workspace
    workspaceArray = [...currentArray];
    selectedIndices = [];
    
    // Update workspace display
    displayWorkspaceArray();
    updateSelectedInfo();
    updateLastAction('None');
    
    // Show modal
    document.getElementById('array-modal').style.display = 'flex';
}

function closeArrayModal() {
    document.getElementById('array-modal').style.display = 'none';
}

function syncToMain() {
    currentArray = [...workspaceArray];
    displayArray(currentArray);
    closeArrayModal();
}

function resetWorkspace() {
    workspaceArray = [...currentArray];
    selectedIndices = [];
    displayWorkspaceArray();
    updateSelectedInfo();
    updateLastAction('Workspace reset');
}

function displayWorkspaceArray(arr) {
    const workspaceDiv = document.getElementById("workspace-array");
    workspaceDiv.innerHTML = workspaceArray.map((num, index) => 
        `<div class="array-box ${selectedIndices.includes(index) ? 'selected' : ''}" data-index="${index}" onclick="toggleSelection(${index})">${num}</div>`
    ).join('');
}

function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    if (!startTime) return;
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function generateArray() {
    fetch(`/generate_array/${algorithm}/${difficulty}/${levelId}`)
        .then(res => res.json())
        .then(data => {
            currentArray = data.array;
            displayArray(currentArray);
            if (!startTime) startTimer();
        });
}

function displayArray(arr) {
    const arrayDiv = document.getElementById("array");
    arrayDiv.innerHTML = arr.map((num, index) => 
        `<div class="array-box ${selectedIndices.includes(index) ? 'selected' : ''}" data-index="${index}" onclick="toggleSelection(${index})">${num}</div>`
    ).join('');
}

// Interactive sorting functions
function toggleSelection(index) {
    const idx = selectedIndices.indexOf(index);
    if (idx > -1) {
        selectedIndices.splice(idx, 1);
    } else {
        if (selectedIndices.length < 2) {
            selectedIndices.push(index);
        } else {
            selectedIndices = [index];
        }
    }
    updateSelectedInfo();
    // Update both displays if modal is open
    if (document.getElementById('array-modal').style.display === 'flex') {
        displayWorkspaceArray();
    } else {
        displayArray(currentArray);
    }
}

function selectElement(position) {
    if (position < workspaceArray.length) {
        toggleSelection(position);
    }
}

function swapElements() {
    if (selectedIndices.length !== 2) {
        alert('Please select exactly 2 elements to swap!');
        return;
    }
    
    const [i, j] = selectedIndices;
    [workspaceArray[i], workspaceArray[j]] = [workspaceArray[j], workspaceArray[i]];
    
    incrementStep();
    updateLastAction(`Swapped elements at positions ${i} and ${j}`);
    selectedIndices = [];
    updateSelectedInfo();
    displayWorkspaceArray();
}

function compareElements() {
    if (selectedIndices.length !== 2) {
        alert('Please select exactly 2 elements to compare!');
        return;
    }
    
    const [i, j] = selectedIndices;
    const comparison = workspaceArray[i] < workspaceArray[j] ? '<' : '>';
    
    incrementStep();
    updateLastAction(`Compared: ${workspaceArray[i]} ${comparison} ${workspaceArray[j]}`);
    alert(`${workspaceArray[i]} ${comparison} ${workspaceArray[j]}`);
}

function moveElement() {
    if (selectedIndices.length !== 1) {
        alert('Please select exactly 1 element to move!');
        return;
    }
    
    const index = selectedIndices[0];
    if (index < workspaceArray.length - 1) {
        [workspaceArray[index], workspaceArray[index + 1]] = [workspaceArray[index + 1], workspaceArray[index]];
        selectedIndices[0] = index + 1;
        
        incrementStep();
        updateLastAction(`Moved element from position ${index} to ${index + 1}`);
        displayWorkspaceArray();
    }
}

function moveElementLeft() {
    if (selectedIndices.length !== 1) {
        alert('Please select exactly 1 element to move!');
        return;
    }
    
    const index = selectedIndices[0];
    if (index > 0) {
        [workspaceArray[index], workspaceArray[index - 1]] = [workspaceArray[index - 1], workspaceArray[index]];
        selectedIndices[0] = index - 1;
        
        incrementStep();
        updateLastAction(`Moved element from position ${index} to ${index - 1}`);
        displayWorkspaceArray();
    }
}

function findSmallest() {
    if (!workspaceArray.length) return;
    
    let minIndex = 0;
    for (let i = 1; i < workspaceArray.length; i++) {
        if (workspaceArray[i] < workspaceArray[minIndex]) {
            minIndex = i;
        }
    }
    
    incrementStep();
    updateLastAction(`Found smallest element: ${workspaceArray[minIndex]} at position ${minIndex}`);
    selectedIndices = [minIndex];
    updateSelectedInfo();
    displayWorkspaceArray();
    alert(`Smallest element is ${workspaceArray[minIndex]} at position ${minIndex}`);
}

function findLargest() {
    if (!workspaceArray.length) return;
    
    let maxIndex = 0;
    for (let i = 1; i < workspaceArray.length; i++) {
        if (workspaceArray[i] > workspaceArray[maxIndex]) {
            maxIndex = i;
        }
    }
    
    incrementStep();
    updateLastAction(`Found largest element: ${workspaceArray[maxIndex]} at position ${maxIndex}`);
    selectedIndices = [maxIndex];
    updateSelectedInfo();
    displayWorkspaceArray();
    alert(`Largest element is ${workspaceArray[maxIndex]} at position ${maxIndex}`);
}

function insertElement() {
    if (selectedIndices.length !== 1) {
        alert('Please select exactly 1 element to insert!');
        return;
    }
    
    const index = selectedIndices[0];
    const value = workspaceArray[index];
    let insertPos = index;
    
    // Find correct position for insertion (for insertion sort)
    for (let i = 0; i < index; i++) {
        if (workspaceArray[i] > value) {
            insertPos = i;
            break;
        }
    }
    
    if (insertPos !== index) {
        // Remove element and insert at correct position
        workspaceArray.splice(index, 1);
        workspaceArray.splice(insertPos, 0, value);
        selectedIndices = [insertPos];
        
        incrementStep();
        updateLastAction(`Inserted element ${value} at position ${insertPos}`);
        displayWorkspaceArray();
    } else {
        alert('Element is already in correct position!');
    }
}

function updateSelectedInfo() {
    const info = selectedIndices.length > 0 
        ? selectedIndices.map(i => `Position ${i}: ${workspaceArray[i] || currentArray[i]}`).join(', ')
        : 'None';
    document.getElementById('selected-elements').textContent = info;
}

function updateLastAction(action) {
    document.getElementById('last-action').textContent = action;
}

function getHint() {
    if (!currentArray.length) {
        alert('Please generate an array first!');
        return;
    }
    
    hintsUsed++;
    document.getElementById('hints-used').textContent = hintsUsed;
    
    fetch(`/get_hint/${algorithm}?array=${currentArray.join(',')}&steps=${steps}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('hint-text').textContent = data.hint;
            document.getElementById('hint-box').style.display = 'block';
        });
}

function closeHint() {
    document.getElementById('hint-box').style.display = 'none';
}

function incrementStep() {
    steps++;
    document.getElementById('steps').textContent = steps;
}

function restartGame() {
    steps = 0;
    hintsUsed = 0;
    selectedIndices = [];
    document.getElementById('steps').textContent = steps;
    document.getElementById('hints-used').textContent = hintsUsed;
    updateSelectedInfo();
    updateLastAction('None');
    stopTimer();
    startTime = null;
    document.getElementById('timer').textContent = '00:00';
    generateArray();
}

function quitGame() {
    if (confirm('Are you sure you want to quit? Your progress will be lost.')) {
        window.location.href = '/level_selection';
    }
}

function submitSolution() {
    if (!currentArray.length) {
        alert('Please generate an array first!');
        return;
    }
    
    stopTimer();
    const timeTaken = Math.floor((Date.now() - startTime) / 1000);
    
    fetch('/submit_solution', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            algorithm: algorithm,
            difficulty: difficulty,
            level_id: levelId,
            steps: steps,
            time_taken: timeTaken,
            hints_used: hintsUsed,
            array: currentArray
        })
    })
    .then(res => res.json())
    .then(data => {
        showResult(data);
    });
}

function showResult(data) {
    const modal = document.getElementById('result-modal');
    const title = document.getElementById('result-title');
    const stats = document.getElementById('result-stats');
    
    if (data.completed) {
        title.textContent = 'üéâ Level Completed!';
        title.className = 'success-title';
    } else {
        title.textContent = 'üí™ Keep Practicing!';
        title.className = 'practice-title';
    }
    
    stats.innerHTML = `
        <div class="result-stat">
            <span>Your Steps: ${steps}</span>
            <span>Optimal Steps: ${data.optimal_steps}</span>
        </div>
        <div class="result-stat">
            <span>Efficiency: ${data.efficiency}%</span>
            <span>Time: ${document.getElementById('timer').textContent}</span>
        </div>
        <div class="result-stat">
            <span>Hints Used: ${hintsUsed}</span>
        </div>
    `;
    
    if (data.quiz_question) {
        currentQuiz = data.quiz_question;
        showQuiz(data.quiz_question);
    }
    
    modal.style.display = 'flex';
}

function showQuiz(quiz) {
    const quizSection = document.getElementById('quiz-section');
    const questionDiv = document.getElementById('quiz-question');
    const optionsDiv = document.getElementById('quiz-options');
    
    questionDiv.innerHTML = `<p><strong>${quiz.question}</strong></p>`;
    optionsDiv.innerHTML = quiz.options.map((option, index) => `
        <label class="quiz-option">
            <input type="radio" name="quiz" value="${index}">
            <span>${option}</span>
        </label>
    `).join('');
    
    quizSection.style.display = 'block';
}

function submitQuizAnswer() {
    const selected = document.querySelector('input[name="quiz"]:checked');
    if (!selected) {
        alert('Please select an answer!');
        return;
    }
    
    const answerIndex = parseInt(selected.value);
    if (answerIndex === currentQuiz.correct) {
        alert('‚úÖ Correct! ' + currentQuiz.explanation);
    } else {
        alert('‚ùå Incorrect. ' + currentQuiz.explanation);
    }
    
    document.getElementById('quiz-section').style.display = 'none';
}

function nextLevel() {
    window.location.href = `/game/${algorithm}/${difficulty}/${levelId + 1}`;
}

function retryLevel() {
    document.getElementById('result-modal').style.display = 'none';
    restartGame();
}

function backToMenu() {
    window.location.href = '/level_selection';
}

// Initialize game on load
window.onload = function() {
    generateArray();
};
</script>

<style>
.game-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.game-header {
    text-align: center;
    margin-bottom: 30px;
}

.game-info {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    gap: 20px;
    align-items: center;
}

.difficulty-badge {
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
}

.difficulty-badge.easy {
    background: #4CAF50;
    color: white;
}

.difficulty-badge.medium {
    background: #FF9800;
    color: white;
}

.difficulty-badge.hard {
    background: #F44336;
    color: white;
}

.level-info {
    color: #888;
}

.game-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.game-stats {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-bottom: 25px;
    background: #1f1f1f;
    padding: 15px;
    border-radius: 10px;
}

.stat-item {
    text-align: center;
}

.stat-label {
    display: block;
    color: #888;
    font-size: 14px;
}

.stat-value {
    display: block;
    font-size: 24px;
    font-weight: bold;
    color: #4CAF50;
}

.array-container {
    margin: 30px 0;
    text-align: center;
}

.array-display {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
    padding: 20px;
    background: #2a2a2a;
    border-radius: 15px;
    min-height: 80px;
}

.array-box {
    background: #2196F3;
    color: white;
    padding: 15px;
    border-radius: 8px;
    min-width: 60px;
    text-align: center;
    font-weight: bold;
    font-size: 18px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.array-box:hover {
    transform: scale(1.05);
    background: #1976D2;
}

.array-box.selected {
    background: #FF9800;
    border: 3px solid #FF5722;
    transform: scale(1.1);
}

.sorting-controls {
    background: #1f1f1f;
    padding: 25px;
    border-radius: 15px;
    margin: 30px 0;
    border: 2px solid #333;
}

.sorting-controls h3 {
    text-align: center;
    margin-bottom: 20px;
    color: #4CAF50;
}

.control-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.control-group {
    background: #2a2a2a;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #444;
}

.control-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: bold;
    color: #2196F3;
}

.control-group button {
    margin: 5px;
    padding: 8px 12px;
    font-size: 12px;
}

.btn-purple {
    background: #9C27B0;
}

.btn-cyan {
    background: #00BCD4;
}

.selected-info {
    background: #2a2a2a;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    color: white;
    font-size: 14px;
}

.selected-info span {
    margin: 0 5px;
}

.selected-info span:first-child {
    color: #2196F3;
    font-weight: bold;
}

.selected-info span:nth-child(3) {
    color: #FF9800;
    font-weight: bold;
}

.action-area {
    text-align: center;
    margin: 30px 0;
}

.btn-large {
    padding: 15px 40px;
    font-size: 18px;
}

.btn-orange {
    background: #FF9800;
}

.btn-red {
    background: #F44336;
}

.btn-success {
    background: #4CAF50;
}

.btn-small {
    padding: 5px 15px;
    font-size: 12px;
}

.hint-box {
    background: #2196F3;
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    position: relative;
}

.hint-box h4 {
    margin-top: 0;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content-large {
    background: #1f1f1f;
    padding: 30px;
    border-radius: 15px;
    max-width: 900px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    text-align: center;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #333;
}

.modal-header h2 {
    margin: 0;
    color: #4CAF50;
}

.modal-body {
    margin-bottom: 20px;
}

.modal-footer {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding-top: 15px;
    border-top: 2px solid #333;
}

.workspace-array {
    margin-bottom: 30px;
    text-align: center;
}

.workspace-array h4 {
    color: #2196F3;
    margin-bottom: 15px;
}

.array-display-large {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    padding: 25px;
    background: #2a2a2a;
    border-radius: 15px;
    min-height: 100px;
    margin: 15px 0;
}

.array-display-large .array-box {
    min-width: 80px;
    padding: 20px;
    font-size: 22px;
}

.sorting-controls {
    background: #1a1a1a;
    padding: 25px;
    border-radius: 15px;
    margin: 20px 0;
    border: 2px solid #333;
}

.success-title {
    color: #4CAF50;
    font-size: 24px;
}

.practice-title {
    color: #FF9800;
    font-size: 24px;
}

.result-stat {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
    padding: 10px;
    background: #2a2a2a;
    border-radius: 8px;
}

.modal-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 25px;
    flex-wrap: wrap;
}

.quiz-option {
    display: block;
    text-align: left;
    margin: 10px 0;
    padding: 10px;
    background: #2a2a2a;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.quiz-option:hover {
    background: #333;
}

.quiz-option input {
    margin-right: 10px;
}
</style>
{% endblock %}
